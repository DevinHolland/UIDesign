<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Prototype</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
</head>
<body>
<style id="stylesheet">

</style>

    <section id="editor">
        <form id="add-new-form-template">
            <label for="html">HTML</label>
            <textarea autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" id="html"></textarea>

            <label for="css">CSS</label>
            <textarea autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" id="css"></textarea>
        </form>

        <div id="play">
            <button id="play-button">Play!</button>
            <button id="stop-button">Stop</button>
        </div>
    </section>

    <section id="game-screen">
    </section>

    <script>
        $(function(){
            var $gameScreen = $("#game-screen");
            var currentHTML = "";
            var gameInterval;

            $(document).delegate('textarea', 'keydown', function(e) {
                var keyCode = e.keyCode || e.which;

                if (keyCode == 9) {
                    e.preventDefault();
                    var start = $(this).get(0).selectionStart;
                    var end = $(this).get(0).selectionEnd;

                    // set textarea value to: text before caret + tab + text after caret
                    $(this).val($(this).val().substring(0, start)
                    + "    "
                    + $(this).val().substring(end));

                    // put caret at right position again
                    $(this).get(0).selectionStart = $(this).get(0).selectionEnd = start + 4;
                }
            });

            $(document).delegate('#html', 'keyup', function(e){
                $('#game-screen').html($(this).val());
            });

            $(document).delegate('#css', 'keyup', function(e){
                $('#stylesheet').html($(this).val());
            });

            function resize() {
                $('section').outerHeight($(window).height());
            }

            resize();
            $(window).resize(resize);

            $('#play-button').on('click', function(){

                currentHTML = $gameScreen.html();

                $('#play-button').hide();
                $('#stop-button').show();

                var gravity = 20;
                var terminalVelocity = 20;
                var $platforms = $gameScreen.find(".platform");
                var $character = $gameScreen.find("#character");
                console.log($character);

                var platforms = [];
                if($character.length == 0){
                    alert("Character required.");
                    return;
                }

                $character.velocity = {x:0,y:0};

                $platforms.each(function(){
                    platforms.push({
                        height: $(this).height(),
                        width: $(this).width(),
                        top: $(this).offset().top,
                        left: $(this).offset().left
                    })
                });


                var curTime = (new Date()).getTime();
                var prevTime;
                var deltaTime;

                gameInterval = setInterval(function(){
                    prevTime = curTime;
                    curTime = Date.now();
                    deltaTime = curTime - prevTime;

                    if($character.velocity.y + (gravity * deltaTime/1000) <= terminalVelocity )
                        $character.velocity.y = $character.velocity.y + (gravity * deltaTime/1000);

                    console.log($character.velocity.y);
                    $character.css({
                        top: $character.offset().top + $character.velocity.y,
                    });
                }, 16);
            });

            $('#stop-button').on('click', function(){
                clearInterval(gameInterval);
                $gameScreen.html(currentHTML);
                currentHTML = '';

                $(this).hide();
                $('#play-button').show();
            });
        });
    </script>
</body>
</html>