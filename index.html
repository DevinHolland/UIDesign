<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Prototype</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
</head>
<body>
    <section id="levels">
        <h1>Levels</h1>
        <div></div>
    </section>

    <section id="game-screen">
    </section>

    <section id="editor">
        <div id="add-new">
            <button id="add-element">Add Element</button>
        </div>
        <h1>Elements</h1>
    </section>

    <div id="hidden-items">
        <form id="add-new-form-template">
            <label for="html">HTML</label>
            <textarea id="html"></textarea>

            <label for="css">CSS</label>
            <textarea id="css">
selector {
    position: absolute;
    top: 0;
    left: 0;
}
            </textarea>

            <button id="submit-add" type="button">Done</button>
        </form>
    </div>

    <script>
        $(function(){
            var $editor = $('#editor');
            var $gameScreen = $("game-screen");
            var $levels = $("#levels");
            var currentSelected = "";
            var lastId = 0;

            $(document).delegate('textarea', 'keydown', function(e) {
                var keyCode = e.keyCode || e.which;

                if (keyCode == 9) {
                    e.preventDefault();
                    var start = $(this).get(0).selectionStart;
                    var end = $(this).get(0).selectionEnd;

                    // set textarea value to: text before caret + tab + text after caret
                    $(this).val($(this).val().substring(0, start)
                    + "    "
                    + $(this).val().substring(end));

                    // put caret at right position again
                    $(this).get(0).selectionStart = $(this).get(0).selectionEnd = start + 4;
                }
            });

            $(document).delegate('#html', 'keyup', function(e){
                console.log("html keyup");
                try {
                    var $currentHTML = $($(this).val());
                    var $previousHTML = $("#" + currentSelected);

                    if ($currentHTML.attr('id') != undefined && $currentHTML.attr('id') != '') {
                        currentSelected = $currentHTML.attr('id');
                    } else if(currentSelected == '') {
                        lastId++;
                        currentSelected = "platform" + (lastId);
                    }

                    $currentHTML.attr('id', currentSelected);

                    if(currentSelected != '') {
                        if ($previousHTML.length == 0) {
                            $("#game-screen").append($currentHTML);
                        } else {
                            $previousHTML.attr('id', currentSelected).html($currentHTML.html());

                            if ($currentHTML.attr("style") != undefined) {
                                $previousHTML.attr('style', $currentHTML.attr("style"));
                            }
                        }
                    }
                } catch(err){

                }
            });

            $(document).delegate("#submit-add", 'click', function(e){
                e.preventDefault();
                currentSelected = '';
                $("#add-new-form").remove();
            });

            function resize() {
                $('section').outerHeight($(window).height());
            }

            resize();
            $(window).resize(resize);

            $("#add-element").on('click', function(){
                $("#add-new-form").remove();

                var newForm = $('#add-new-form-template').clone();
                newForm.attr('id', 'add-new-form');
                $("#add-new").append(newForm);
            });
        });
    </script>
</body>
</html>